name: Bulldozer Platform ci

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  ci:
    runs-on: ubuntu-20.04
    env:
      BEFORE_SHA: ${{ github.event.before }}
    steps:
      - id: config-repo
        name: Pre config - ğŸ§° Checkout repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - id: config-node
        name: Pre config - ğŸ§° Setting up Node 14.7.5
        uses: actions/setup-node@v2
        with:
          node-version: '14.17.5' # we have to check this

      - id: install-npm-packages
        name: ğŸ“¦ Pulling repo and installing Bulldozer Platform npm packages
        run: |
          git fetch --prune origin master
          npm ci

      - id: get-affected-projects
        name: ğŸ› ï¸ Getting affected projects
        shell: bash
        # Here we use the `npx nx print-affected` command to get all the affected projects in a single string
        # then using grep, we count (using the -c flag) the occurrences of 'bulldozer-program' string in the above result
        # if we get 0, it means the bulldozer-program does not changed, otherwise it changed and we will install Anchor
        run: |
          echo "::set-output name=bulldozer-program-affected::$(echo $(npx nx print-affected --select=projects --base=$BEFORE_SHA) | grep -c "bulldozer-programs")"

      - id: install-anchor
        name: ğŸ› ï¸ Setting up Anchor, Rust, Solana and others related dependencies
        if: steps.get-affected-projects.outputs.bulldozer-program-affected != 0
        run: |
          echo "Installing Rust >>"
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup component add rustfmt

          echo "Installing Solana >> "
          sh -c "$(curl -sSfL https://release.solana.com/v1.7.11/install)"
          echo "-- adding new solana key file"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana-keygen new -o $HOME/.config/solana/id.json

          echo "Installing Serum >> "
          npm i -g @project-serum/anchor 
          npm i -g @project-serum/anchor-cli

          echo "Installing others dependencies >>"
          npm i -g typescript
          npm install -g mocha
          npm install -g ts-mocha

      - id: building-projects
        name: ğŸ—ï¸ Building Bulldozer Platform projects
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          npx nx affected --target=build --base=$BEFORE_SHA

      - id: testing-projects
        name: ğŸ§ª Running Bulldozer Platform projects tests
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          npx nx affected --target=test --base=$BEFORE_SHA
